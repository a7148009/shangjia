# 分辨率适配说明

## 🎯 问题

之前的代码使用**硬编码的像素值**，导致换手机后定位失败：

```python
# ❌ 旧代码 - 硬编码像素值
self.zones = {
    'name_area': {'y_min': 600, 'y_max': 800},    # 只适配1080x2400
    'info_area': {'y_min': 800, 'y_max': 1200},
}

params = {
    'safe_y_min': 500,   # 只适配1080x2400
    'safe_y_max': 1800,
}
```

**问题**：换成其他分辨率（如720x1600、1440x3200），区域会错位！

---

## ✅ 解决方案

使用**相对屏幕高度的比例**（百分比），自动适配所有分辨率：

```python
# ✅ 新代码 - 使用比例
self.zone_ratios = {
    'name_area': {'y_min': 0.25, 'y_max': 0.35},    # 25%-35%屏幕高度
    'info_area': {'y_min': 0.35, 'y_max': 0.55},    # 35%-55%屏幕高度
}

params = {
    'safe_y_min_ratio': 0.20,   # 20%屏幕高度
    'safe_y_max_ratio': 0.75,   # 75%屏幕高度
}

# 初始化时自动计算实际像素值
self.zones['name_area']['y_min'] = int(screen_height * 0.25)
self.zones['name_area']['y_max'] = int(screen_height * 0.35)
```

---

## 📱 适配效果对比

### 1. 你的测试机（1080x2400）

#### 商家卡片区域（搜索结果页）
```
📱 屏幕尺寸: 1080x2400
📐 商家列表区域:
   Y轴范围: 480-1800 像素
   (20%-75%屏幕高度)
```

#### 商家详情区域
```
📱 屏幕尺寸: 1080x2400
📐 区域划分:
   照片区域: Y=192-600      (8%-25%)
   商家名区域: Y=600-840     (25%-35%)
   信息区域: Y=840-1320     (35%-55%)
```

---

### 2. 小屏手机（720x1600）

#### 商家卡片区域
```
📱 屏幕尺寸: 720x1600
📐 商家列表区域:
   Y轴范围: 320-1200 像素
   (20%-75%屏幕高度)
```

#### 商家详情区域
```
📱 屏幕尺寸: 720x1600
📐 区域划分:
   照片区域: Y=128-400      (8%-25%)
   商家名区域: Y=400-560     (25%-35%)
   信息区域: Y=560-880      (35%-55%)
```

---

### 3. 大屏手机（1440x3200）

#### 商家卡片区域
```
📱 屏幕尺寸: 1440x3200
📐 商家列表区域:
   Y轴范围: 640-2400 像素
   (20%-75%屏幕高度)
```

#### 商家详情区域
```
📱 屏幕尺寸: 1440x3200
📐 区域划分:
   照片区域: Y=256-800      (8%-25%)
   商家名区域: Y=800-1120    (25%-35%)
   信息区域: Y=1120-1760    (35%-55%)
```

---

## 🔧 修改的文件

### 1. merchant_detail_locator.py
- ✅ 将固定像素值改为比例
- ✅ 初始化时自动计算像素值
- ✅ 打印区域划分信息（方便调试）

### 2. merchant_card_locator.py
- ✅ 添加 `safe_y_min_ratio` 和 `safe_y_max_ratio`
- ✅ 初始化时自动转换为像素值
- ✅ 保留固定值作为备用（兼容旧配置）

---

## 📊 适配原理

### 原理图：

```
屏幕高度 = 100%
┌─────────────────────────────────┐
│  0% - 顶部状态栏                 │
│  ├─────────────────────────────┤
│  8% - 照片区域开始               │  ← 详情页
│  ├─────────────────────────────┤
│  20% - 商家列表区域开始          │  ← 搜索结果页
│  ├─────────────────────────────┤
│  25% - 商家名区域开始            │  ← 详情页
│  ├─────────────────────────────┤
│  35% - 信息区域开始（红框）      │  ← 详情页
│  ├─────────────────────────────┤
│  55% - 信息区域结束              │
│  ├─────────────────────────────┤
│  75% - 商家列表区域结束          │
│  ├─────────────────────────────┤
│  85% - 内容区域结束              │
│  ├─────────────────────────────┤
│  100% - 底部导航栏               │
└─────────────────────────────────┘
```

### 为什么用比例？

1. **APP布局是响应式的**
   - 高德地图APP在不同分辨率下，布局比例是相同的
   - 商家名总是在详情页的25%-35%高度
   - 红框信息总是在35%-55%高度

2. **像素值会错位**
   - 720x1600的600像素 = 37.5%高度
   - 1440x3200的600像素 = 18.75%高度
   - 同样的600像素，在不同分辨率意义完全不同！

3. **比例保持一致**
   - 720x1600的25% = 400像素
   - 1440x3200的25% = 800像素
   - 都能准确定位到商家名区域！

---

## 🧪 测试建议

### 测试步骤：

1. **在你的测试机上测试**（1080x2400）
   ```bash
   python main.py
   ```
   - 验证商家卡片识别正常
   - 验证商家详情提取正常

2. **如果有其他手机，也测试一下**
   - 小屏手机（如720x1280、720x1600）
   - 大屏手机（如1440x3200、1080x2340）

3. **观察初始化输出**
   ```
   📱 屏幕尺寸: 1080x2400
   📐 区域划分（像素）:
      照片区域: Y=192-600
      商家名区域: Y=600-840
      信息区域: Y=840-1320
   ```

4. **如果定位不准，可以调整比例**
   - 在config.yaml中修改 `safe_y_min_ratio`、`safe_y_max_ratio`
   - 或直接修改 `merchant_detail_locator.py` 中的 `zone_ratios`

---

## 🎉 总结

现在的代码可以：

✅ **自动适配所有分辨率**
- 不需要为每个手机写不同的配置
- 换手机后自动计算正确的像素值

✅ **保持商家卡片的成功经验**
- 商家卡片识别也用了比例
- 详情页提取复制了这个经验

✅ **兼容性更好**
- 保留了固定像素值作为备用
- 如果没有配置比例，会使用默认固定值

✅ **调试更方便**
- 初始化时打印区域划分
- 可以快速验证是否准确

---

**修复日期**：2025-01-16
**核心改进**：使用比例代替固定像素值
**影响范围**：所有分辨率的Android手机
