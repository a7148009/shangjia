# 商家名匹配验证方案

## 问题描述

当前问题：
```
卡片识别名称: "蓝薇花卉"
点击后进入: "馨爱鲜花.绿植.开业花篮.场地布置.气球派对（昆明店）"
        ↑ 名称完全不匹配！这是广告页面
```

## 验证逻辑

### 方案1：严格匹配（推荐）

```python
def verify_merchant_name_match(expected_name: str, actual_name: str) -> bool:
    """
    验证商家名是否匹配

    Args:
        expected_name: 卡片上的商家名
        actual_name: 详情页的商家名

    Returns:
        是否匹配
    """
    # 清理括号和特殊字符
    expected_clean = re.sub(r'[（）()·.。]', '', expected_name)
    actual_clean = re.sub(r'[（）()·.。]', '', actual_name)

    # 策略1：完全匹配
    if expected_clean == actual_clean:
        return True

    # 策略2：核心关键词匹配（至少50%重合）
    expected_keywords = set(expected_clean)
    actual_keywords = set(actual_clean)

    if len(expected_keywords) == 0:
        return False

    common = expected_keywords & actual_keywords
    match_ratio = len(common) / len(expected_keywords)

    # 至少匹配50%的字符
    if match_ratio >= 0.5:
        return True

    # 策略3：包含关系（期望名是实际名的子集）
    if expected_clean in actual_clean:
        return True

    return False
```

### 方案2：智能匹配（宽松）

```python
def smart_match_merchant_name(expected: str, actual: str) -> Dict:
    """
    智能匹配商家名

    Returns:
        {
            'match': bool,           # 是否匹配
            'confidence': float,     # 匹配置信度
            'reason': str            # 匹配原因
        }
    """
    # 提取核心词（至少3个字）
    expected_words = set(re.findall(r'[\u4e00-\u9fa5]{3,}', expected))
    actual_words = set(re.findall(r'[\u4e00-\u9fa5]{3,}', actual))

    # 完全匹配
    if expected == actual:
        return {'match': True, 'confidence': 1.0, 'reason': '完全匹配'}

    # 核心词匹配
    common_words = expected_words & actual_words
    if common_words:
        confidence = len(common_words) / len(expected_words) if expected_words else 0
        if confidence >= 0.5:
            return {'match': True, 'confidence': confidence, 'reason': f'核心词匹配: {common_words}'}

    # 包含关系
    expected_clean = re.sub(r'[（）()·.。\s]', '', expected)
    actual_clean = re.sub(r'[（）()·.。\s]', '', actual)

    if expected_clean in actual_clean:
        return {'match': True, 'confidence': 0.8, 'reason': '包含关系'}

    # 字符重合度
    expected_chars = set(expected_clean)
    actual_chars = set(actual_clean)
    common_chars = expected_chars & actual_chars

    if len(expected_chars) > 0:
        char_ratio = len(common_chars) / len(expected_chars)
        if char_ratio >= 0.6:
            return {'match': True, 'confidence': char_ratio, 'reason': f'字符重合{char_ratio:.0%}'}

    return {'match': False, 'confidence': 0.0, 'reason': '名称不匹配'}
```

## 实际案例测试

### 案例1：正常匹配

```python
expected = "蓝薇花卉"
actual = "蓝薇花卉（官渡店）"

result = smart_match_merchant_name(expected, actual)
# {'match': True, 'confidence': 0.8, 'reason': '包含关系'}
```

### 案例2：广告误匹配（应拒绝）

```python
expected = "蓝薇花卉"
actual = "馨爱鲜花.绿植.开业花篮.场地布置.气球派对（昆明店）"

result = smart_match_merchant_name(expected, actual)
# {'match': False, 'confidence': 0.0, 'reason': '名称不匹配'}
```

### 案例3：变体匹配

```python
expected = "成都郊然光域鲜花店"
actual = "郊然光域鲜花店"

result = smart_match_merchant_name(expected, actual)
# {'match': True, 'confidence': 0.8, 'reason': '包含关系'}
```

## 集成到采集流程

```python
# 在点击商家后，验证详情页
def collect_single_merchant(card: Dict):
    expected_name = card['name']

    # 1. 点击卡片
    click(card['click_point'])
    time.sleep(2)

    # 2. 获取详情页
    xml = get_ui_hierarchy()
    actual_name = extract_merchant_name_from_detail(xml)

    # 3. 验证名称匹配
    match_result = smart_match_merchant_name(expected_name, actual_name)

    if not match_result['match']:
        print(f"✗ 商家名不匹配")
        print(f"   期望: {expected_name}")
        print(f"   实际: {actual_name}")
        print(f"   原因: {match_result['reason']}")
        go_back()
        return None

    print(f"✓ 商家名匹配 (置信度: {match_result['confidence']:.0%})")

    # 4. 提取信息
    merchant_data = extract_merchant_info(xml)
    merchant_data['name_match_confidence'] = match_result['confidence']

    return merchant_data
```

## 额外保护：广告特征检测

```python
def is_advertisement_page(xml_content: str) -> bool:
    """
    检测是否是广告页面
    """
    all_text = extract_all_text(xml_content)

    # 广告特征词
    ad_features = [
        '场地布置', '气球派对', '开业花篮',
        '满减', '优惠券', '立即领取',
        '高德推荐', '广告', '推广'
    ]

    # 计数命中的广告特征
    hit_count = sum(1 for keyword in ad_features if keyword in all_text)

    # 命中3个以上特征，判定为广告
    return hit_count >= 3
```

## 完整验证流程

```python
def safe_collect_merchant(card: Dict) -> Optional[Dict]:
    """
    安全采集单个商家（带完整验证）
    """
    expected_name = card['name']

    # 步骤1：点击
    click(card)
    time.sleep(2)

    # 步骤2：获取页面
    xml = get_ui_hierarchy()

    # 步骤3：检测广告
    if is_advertisement_page(xml):
        print(f"✗ 检测到广告页面，跳过")
        go_back()
        return None

    # 步骤4：提取商家名
    actual_name = extract_merchant_name_from_detail(xml)

    # 步骤5：验证匹配
    match_result = smart_match_merchant_name(expected_name, actual_name)

    if not match_result['match']:
        print(f"✗ 商家名不匹配 (置信度: {match_result['confidence']:.0%})")
        print(f"   期望: {expected_name}")
        print(f"   实际: {actual_name}")
        go_back()
        return None

    if match_result['confidence'] < 0.5:
        print(f"⚠ 匹配置信度较低: {match_result['confidence']:.0%}")

    # 步骤6：提取信息
    data = extract_merchant_info(xml)
    data['expected_name'] = expected_name
    data['actual_name'] = actual_name
    data['name_match_confidence'] = match_result['confidence']

    return data
```

## 推荐配置

```yaml
validation:
  # 商家名匹配
  min_name_match_confidence: 0.5   # 最低匹配置信度
  strict_mode: false               # 严格模式（要求完全匹配）

  # 广告检测
  ad_feature_threshold: 3          # 广告特征词阈值

  # 失败处理
  max_mismatch_before_stop: 5      # 连续不匹配次数上限
```

---

**结论**：必须加入商家名匹配验证，这是防止点击错误的最后一道防线！
