# 当前运行脚本说明

## 🔍 问题分析

您运行 `run.bat` 后启动的是 **旧版采集系统**，而不是我们新开发的智能采集系统！

---

## 📂 脚本执行流程

```
run.bat
  │
  ├──> 执行: python main_window.py
  │
  └──> main_window.py (图形界面程序)
         │
         ├──> 使用: MerchantCollector (旧版采集器)
         │
         └──> 调用: merchant_collector.py (第17行导入)
```

---

## ⚠️ 核心问题

### 1. 广告过滤不完整

**当前代码位置**: `merchant_collector.py` 第377-406行

```python
def _is_advertisement(self, text: str) -> bool:
    # 广告关键词
    ad_keywords = [
        '高德红包', '优惠', '券', '领取', '满减', '折扣', '减',
        '刚刚浏览', '大家还在搜', '推荐', '榜单',
        '扫街榜', '爆款', '精选', '新客', '满', '已领取'
    ]
    # ❌ 缺少关键词：'场地布置', '气球派对', '开业花篮', '绿植', '馨爱鲜花'
```

**问题**: 缺少了您提到的广告关键词，导致 "馨爱鲜花.绿植.开业花篮.场地布置.气球派对（昆明店）" 这类广告卡片通过了过滤。

---

### 2. 没有商家名匹配验证

**当前流程** (`main_window.py` 第76-130行):

```python
# 点击商家卡片
self.adb_manager.click(merchant_card['click_x'], merchant_card['click_y'])
time.sleep(2)

# 直接采集详情 ❌ 没有验证商家名是否匹配
merchant_detail = self.collector.collect_merchant_detail()
```

**问题**: 点击后没有验证详情页的商家名是否与卡片名匹配，导致即使点错了也会继续提取信息。

---

### 3. Y轴过滤参数过于宽松

**当前代码位置**: `merchant_collector.py` 第274-277行

```python
# 严格的Y轴区域过滤（商家列表在屏幕中部）
# 根据日志：真商家在 Y=533-700，广告在 Y=408-452
if y1 < 450 or y2 > 1000:
    return None
```

**问题**: Y轴最小值设置为450，而您的日志显示真正商家从Y=612开始。广告区域Y=255-561被部分允许通过。

---

## 🆚 新旧系统对比

| 模块 | 旧系统 (merchant_collector.py) | 新系统 (smart_collector.py) |
|------|--------------------------------|----------------------------|
| **广告过滤** | ❌ 不完整（缺少关键词） | ✅ 完整（包含所有广告特征词） |
| **商家名验证** | ❌ 无 | ✅ 点击后验证名称匹配 |
| **页面状态验证** | ⚠️ 简单检查 | ✅ 完整的5步验证流程 |
| **Y轴过滤** | ⚠️ 450 (过宽松) | ✅ 500-600可配置 |
| **布局支持** | ⚠️ 仅85%以上宽度 | ✅ 60%-98%宽度（支持多城市） |
| **错误恢复** | ⚠️ 基本支持 | ✅ 完整的错误分类和统计 |

---

## 🛠️ 解决方案

### 方案1：修复旧系统（快速修复）

修改 `merchant_collector.py` 文件，增强广告过滤：

```python
# 在 _is_advertisement 方法中添加关键词
ad_keywords = [
    '高德红包', '优惠', '券', '领取', '满减', '折扣', '减',
    '刚刚浏览', '大家还在搜', '推荐', '榜单',
    '扫街榜', '爆款', '精选', '新客', '满', '已领取',
    # 🆕 新增关键词
    '鲜花上门配送', '上门配送', '配送服务', '买花榜',
    '鲜花配送', '送货上门', '配送推荐', '服务', '推荐商家',
    '场地布置', '气球派对', '开业花篮', '绿植',
    '（昆明店）', '（成都店）', '（西安店）',
    '馨爱鲜花'
]
```

同时调整Y轴过滤：

```python
# 第276行
if y1 < 500 or y2 > 1000:  # 从450改为500
    return None
```

---

### 方案2：切换到新系统（推荐）

修改 `main_window.py`，使用智能采集器：

```python
# 第17行，替换导入
# from merchant_collector import MerchantCollector  # 旧版
from smart_collector import SmartCollector  # 新版

# 第544行，替换实例化
# self.collector = MerchantCollector(self.adb_manager)  # 旧版
screen_width, screen_height = self.adb_manager.get_screen_size()
self.collector = SmartCollector(self.adb_manager, screen_width, screen_height)  # 新版

# 第61-82行，替换采集流程
# 旧版流程
merchants = self.collector.parse_merchant_list()
for merchant_card in merchants:
    self.adb_manager.click(merchant_card['click_x'], merchant_card['click_y'])
    merchant_detail = self.collector.collect_merchant_detail()

# 替换为新版流程（带验证）
result = self.collector.collect_from_search_page(debug=True)
merchants_data = result['data']
```

---

## 📋 详细修改步骤 (方案1 - 快速修复)

### 步骤1: 增强广告过滤

编辑 `D:\info\merchant_collector.py` 第377-406行：

```python
def _is_advertisement(self, text: str) -> bool:
    """
    识别并排除广告内容

    Args:
        text: 文本内容

    Returns:
        是否为广告
    """
    # 广告关键词（增强版）
    ad_keywords = [
        '高德红包', '优惠', '券', '领取', '满减', '折扣', '减',
        '刚刚浏览', '大家还在搜', '推荐', '榜单', '服务推荐',
        '扫街榜', '爆款', '精选', '新客', '满', '已领取',
        '鲜花上门配送', '上门配送', '配送服务', '买花榜',
        '鲜花配送', '送货上门', '配送推荐', '服务', '推荐商家',
        # 🆕 强化过滤：组合词
        '场地布置', '气球派对', '开业花篮', '绿植',
        '（昆明店）', '（成都店）', '（西安店）',  # 连锁广告特征
        '馨爱鲜花'  # 明确的广告商家
    ]

    for keyword in ad_keywords:
        if keyword in text:
            return True

    # 排除时间格式（如 "半夜12:12"）
    if re.match(r'.{0,3}\d{1,2}:\d{2}', text):
        return True

    # 排除纯数字加单位（如 "5.8公里"）
    if re.match(r'^\d+\.?\d*\s?(公里|km|米|m|分钟)$', text):
        return True

    return False
```

### 步骤2: 调整Y轴过滤

编辑 `D:\info\merchant_collector.py` 第274-277行：

```python
# 严格的Y轴区域过滤（商家列表在屏幕中部）
# 昆明：真商家从 Y=612 开始，广告在 Y=255-561
# 成都：真商家从 Y=533 开始
if y1 < 500 or y2 > 1000:  # 🆕 从450改为500
    return None
```

### 步骤3: 添加商家名匹配验证

编辑 `D:\info\merchant_collector.py`，在 `collect_merchant_detail` 方法中添加验证：

```python
def collect_merchant_detail(self, merchant_name: str = None) -> Optional[Dict]:
    """
    采集当前商家详情页的核心信息

    Args:
        merchant_name: 期望的商家名称（用于验证）

    Returns:
        商家详细信息字典
    """
    merchant_data = {
        'name': '',
        'address': '',
        'phones': [],
        'image_urls': []
    }

    try:
        # 等待页面加载
        time.sleep(2)

        # 获取UI层级
        xml_content = self.adb_manager.get_ui_hierarchy()
        if not xml_content:
            print("无法获取商家详情页UI")
            return None

        root = etree.fromstring(xml_content.encode('utf-8'))
        screen_width, screen_height = self.adb_manager.get_screen_size()

        # 1. 提取商家名称（优先HTML格式，严格过滤）
        merchant_data['name'] = self._extract_merchant_name_from_detail(root, screen_height)

        # 🆕 2. 验证商家名是否匹配
        if merchant_name:
            expected_clean = re.sub(r'[（）()·.。\s]', '', merchant_name)
            actual_clean = re.sub(r'[（）()·.。\s]', '', merchant_data['name'])

            # 策略1: 完全匹配
            if expected_clean == actual_clean:
                print(f"✓ 商家名匹配: {merchant_name}")
            # 策略2: 包含关系（期望名是实际名的子集）
            elif expected_clean in actual_clean:
                print(f"⚠ 商家名部分匹配: 期望'{merchant_name}' / 实际'{merchant_data['name']}'")
            # 策略3: 字符重合度检查
            else:
                expected_chars = set(expected_clean)
                actual_chars = set(actual_clean)
                common_chars = expected_chars & actual_chars

                if len(expected_chars) > 0:
                    match_ratio = len(common_chars) / len(expected_chars)

                    if match_ratio < 0.5:  # 重合度低于50%
                        print(f"✗ 商家名不匹配！")
                        print(f"   期望: {merchant_name}")
                        print(f"   实际: {merchant_data['name']}")
                        print(f"   重合度: {match_ratio:.0%}")
                        print(f"   → 这可能是广告页面，跳过")
                        return None  # 🆕 不匹配则返回None
                    else:
                        print(f"⚠ 商家名相似度: {match_ratio:.0%}")

        # 3. 提取地址（包含具体地址关键词）
        all_text_nodes = root.xpath('//node[@text and string-length(@text) > 0 and @bounds]')
        for node in all_text_nodes:
            text = node.get('text', '').strip()
            # 地址特征：包含区/路/街/号，且长度较长
            if any(keyword in text for keyword in ['区', '路', '街', '号', '道', '巷']):
                if len(text) > 10:
                    merchant_data['address'] = text
                    break

        # 4. 点击电话图标获取电话号码
        phones = self._click_and_extract_phone(root, screen_width, screen_height)
        merchant_data['phones'] = phones

        # 5. 截图保存顶部图片区域
        merchant_data['image_urls'] = ['screenshot_0']

        return merchant_data

    except Exception as e:
        print(f"采集商家详情失败: {e}")
        import traceback
        traceback.print_exc()
        return None
```

### 步骤4: 修改主窗口调用

编辑 `D:\info\main_window.py` 第76-82行：

```python
# 点击商家卡片进入详情页
self.adb_manager.click(merchant_card['click_x'], merchant_card['click_y'])
time.sleep(2)

# 🆕 传递期望的商家名称进行验证
merchant_detail = self.collector.collect_merchant_detail(merchant_card['name'])

if merchant_detail and merchant_detail['name']:
    # ... 后续处理
```

---

## ✅ 修复后的效果

修复后，系统将能够：

1. ✅ **过滤广告卡片**: "馨爱鲜花.绿植.开业花篮.场地布置.气球派对" 会在识别阶段被过滤
2. ✅ **验证商家名**: 即使点击了错误卡片，也会在详情页发现名称不匹配并跳过
3. ✅ **更严格的Y轴过滤**: Y < 500的广告区域会被过滤掉
4. ✅ **详细日志**: 每次不匹配都会输出详细原因

---

## 🔧 测试步骤

修改完成后：

1. 保存所有文件
2. 重新运行 `run.bat`
3. 在高德地图中搜索"鲜花"
4. 点击"开始采集"
5. 观察日志，应该会看到：
   ```
   ⚠ 跳过广告: 馨爱鲜花.绿植.开业花篮.场地布置.气球派对（昆明店）
   ```

---

## 📚 相关文件

- **当前运行**: `run.bat` → `main_window.py` → `merchant_collector.py` (旧版)
- **新智能系统**: `smart_collector.py` + `page_state_analyzer.py` (已开发完成)
- **配置文件**: `config.yaml`
- **定位器**: `merchant_card_locator.py` (已更新，但旧系统未完全使用)

---

**建议**: 先使用方案1快速修复当前问题，后续有时间再切换到方案2的新智能系统。

**更新时间**: 2025-01-16
