# ä¿®å¤æ–¹æ¡ˆï¼šå•†å®¶åå’Œè¯¦æƒ…é¡µä¿¡æ¯æå–

## ğŸ”´ é—®é¢˜è¯Šæ–­

### é—®é¢˜1ï¼šå•†å®¶å¡ç‰‡åç§°æå–é”™è¯¯

**å½“å‰æå–ç»“æœ**ï¼ˆé”™è¯¯ï¼‰ï¼š
```
ã€å¼—æ´›ä¼Šå¾·ã€‘5æ”¯å®¶å±…é²œèŠ±ç“¶æ’èŠ±ï¼ˆä¸å«èŠ±ç“¶ï¼‰æ˜†æ˜èŠ±åº—ä»…é™åˆ°åº—é¡¾å®¢è‡ªå–
ã€å¿µå±¿è¶åºã€‘ç«ç‘°èŠ±æŸè´è¶å…°éƒé‡‘é¦™è“æ˜ŸèŠ±å‰‘å…°æ··æ­èŠ±æŸçº¦ä¼šèŠ±æŸç”Ÿæ—¥èŠ±æŸ ç”Ÿæ—¥é²œèŠ±
```
âŒ è¿™æ˜¯**å•†å“åç§°**ï¼Œä¸æ˜¯å•†å®¶åï¼

**æ­£ç¡®çš„å•†å®¶å**ï¼ˆä»æˆªå›¾è¯†åˆ«ï¼‰ï¼š
```
æ‹‚è‹èŠ±åº—Floral.æ˜†æ˜
è³åº¦èŠ±åº—(æµ·ä¹ä¸–ç•Œåº—)
```
âœ… è¿™æ‰æ˜¯**å•†å®¶åç§°**ï¼ˆé»‘è‰²åŠ ç²—å­—ä½“ï¼‰

---

### é—®é¢˜2ï¼šè¯¦æƒ…é¡µä¿¡æ¯æå–ä½ç½®é”™è¯¯

**å½“å‰æå–é€»è¾‘**ï¼š
- ä»æ•´ä¸ªé¡µé¢éšæœºæŸ¥æ‰¾æ–‡æœ¬
- æ²¡æœ‰å®šä½åˆ°çº¢æ¡†åŒºåŸŸï¼ˆå•†å®¶è¯¦æƒ…ä¿¡æ¯åŒºåŸŸï¼‰

**æ­£ç¡®çš„æå–ä½ç½®**ï¼ˆå›¾3çº¢æ¡†åŒºåŸŸï¼‰ï¼š
- å•†å®¶åç§°ï¼šé¡µé¢é¡¶éƒ¨å¤§æ ‡é¢˜
- ç”µè¯ï¼šçº¢æ¡†åŒºåŸŸçš„"ç”µè¯"æŒ‰é’®é™„è¿‘
- åœ°å€ï¼šçº¢æ¡†åŒºåŸŸçš„åœ°å€æ–‡æœ¬
- è¥ä¸šæ—¶é—´ï¼šçº¢æ¡†åŒºåŸŸçš„è¥ä¸šæ—¶é—´æ–‡æœ¬

---

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®å¤å•†å®¶å¡ç‰‡åç§°æå–é€»è¾‘

#### å…³é”®å‘ç°ï¼š
å•†å®¶å¡ç‰‡çš„XMLç»“æ„ç‰¹å¾ï¼š
1. **å•†å®¶å**ï¼šåœ¨ViewGroupçš„**ç¬¬ä¸€ä¸ªæˆ–ç¬¬äºŒä¸ª**æ–‡æœ¬èŠ‚ç‚¹ï¼Œä¸”ï¼š
   - é•¿åº¦é€‚ä¸­ï¼ˆ4-20å­—ç¬¦ï¼‰
   - å­—ä½“è¾ƒå¤§ï¼ˆé€šå¸¸æ˜¯åŠ ç²—ï¼‰
   - ä¸åŒ…å«ã€ã€‘ã€å•†å“æè¿°è¯
   - Yè½´ä½ç½®åœ¨å¡ç‰‡é¡¶éƒ¨

2. **å•†å“å**ï¼šé€šå¸¸ï¼š
   - åŒ…å«ã€ã€‘ã€è¯¦ç»†æè¿°
   - é•¿åº¦å¾ˆé•¿ï¼ˆ>30å­—ç¬¦ï¼‰
   - Yè½´ä½ç½®åœ¨å•†å®¶åä¸‹æ–¹

#### ä¿®å¤ä»£ç ï¼š

```python
def _extract_merchant_name(self, node) -> str:
    """
    æå–å•†å®¶åç§°ï¼ˆ2025-01-16å®Œå…¨é‡æ„ï¼‰

    å…³é”®ç‰¹å¾ï¼š
    1. é»‘è‰²åŠ ç²—æ–‡å­—ï¼ˆåœ¨å¡ç‰‡é¡¶éƒ¨ï¼‰
    2. é•¿åº¦4-20å­—ç¬¦
    3. ä¸åŒ…å«ã€ã€‘ç­‰å•†å“æ ‡è¯†
    4. Yè½´ä½ç½®åœ¨å¡ç‰‡ä¸ŠåŠéƒ¨åˆ†
    """
    bounds = self._parse_bounds(node.get('bounds', ''))
    if not bounds:
        return "æœªçŸ¥å•†å®¶"

    card_top = bounds['y1']
    card_height = bounds['height']

    # æŸ¥æ‰¾æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹
    text_nodes = node.xpath('.//node[@text and string-length(@text) > 0 and @bounds]')

    candidate_names = []

    for text_node in text_nodes:
        text = text_node.get('text', '').strip()

        # æ¸…ç†HTMLæ ‡ç­¾
        clean_text = re.sub(r'<[^>]+>', '', text).strip()

        if not clean_text or len(clean_text) < 3:
            continue

        # ğŸ†• å…³é”®è¿‡æ»¤1ï¼šæ’é™¤å•†å“åç‰¹å¾
        if any(marker in clean_text for marker in ['ã€', 'ã€‘', '(', 'ï¼ˆ']):
            # ä½†å¦‚æœåªæ˜¯æ‹¬å·+åº—åï¼Œå¯èƒ½æ˜¯å•†å®¶å
            if clean_text.count('(') <= 1 and clean_text.count('ï¼ˆ') <= 1:
                if len(clean_text) <= 30:
                    pass  # å¯èƒ½æ˜¯å•†å®¶åï¼Œç»§ç»­æ£€æŸ¥
                else:
                    continue  # å¤ªé•¿ï¼Œæ˜¯å•†å“å
            else:
                continue  # å¤šä¸ªæ‹¬å·ï¼Œæ˜¯å•†å“å

        # ğŸ†• å…³é”®è¿‡æ»¤2ï¼šé•¿åº¦åˆ¤æ–­ï¼ˆå•†å®¶å4-30å­—ç¬¦ï¼‰
        if len(clean_text) > 30:
            continue  # å¤ªé•¿ï¼Œæ˜¯å•†å“åæˆ–æè¿°

        # ğŸ†• å…³é”®è¿‡æ»¤3ï¼šæ’é™¤å•†å“æè¿°è¯
        product_keywords = [
            'èŠ±æŸ', 'é²œèŠ±', 'é…é€', 'ä¸Šé—¨', 'åº—é“º', 'ä»…é™',
            'ä¸å«', 'æŒ‡å®š', 'å…¨å›½', 'å®ä½“åº—', 'é€Ÿé€’'
        ]
        keyword_count = sum(1 for kw in product_keywords if kw in clean_text)
        if keyword_count >= 3:
            continue  # åŒ…å«3ä¸ªä»¥ä¸Šå•†å“è¯ï¼Œæ˜¯å•†å“å

        # ğŸ†• å…³é”®è¿‡æ»¤4ï¼šæ’é™¤åœ°å€å’Œè·ç¦»
        if self._is_address_text(clean_text):
            continue
        if self._is_excluded_text(clean_text):
            continue
        if self._is_tag_text(clean_text):
            continue

        # ğŸ†• å…³é”®è¿‡æ»¤5ï¼šYè½´ä½ç½®ï¼ˆåº”è¯¥åœ¨å¡ç‰‡ä¸ŠåŠéƒ¨åˆ†ï¼‰
        text_bounds = self._parse_bounds(text_node.get('bounds', ''))
        if text_bounds:
            text_y = text_bounds['y1']
            relative_y = (text_y - card_top) / card_height if card_height > 0 else 1

            # å•†å®¶åé€šå¸¸åœ¨å¡ç‰‡å‰30%çš„ä½ç½®
            if relative_y > 0.3:
                continue

        # æ·»åŠ åˆ°å€™é€‰åå•
        candidate_names.append({
            'text': clean_text,
            'length': len(clean_text),
            'y_pos': text_bounds['y1'] if text_bounds else 9999
        })

    # é€‰æ‹©æœ€åˆé€‚çš„å•†å®¶å
    if not candidate_names:
        return "æœªçŸ¥å•†å®¶"

    # æ’åºè§„åˆ™ï¼š
    # 1. Yè½´ä½ç½®è¶Šé ä¸Šè¶Šå¥½
    # 2. é•¿åº¦4-20å­—ç¬¦ä¼˜å…ˆ
    # 3. é•¿åº¦é€‚ä¸­ä¼˜å…ˆ
    candidate_names.sort(key=lambda x: (
        x['y_pos'],                              # Yè½´ä½ç½®æœ€é‡è¦
        abs(x['length'] - 10),                   # é•¿åº¦æ¥è¿‘10æœ€å¥½
        -x['length'] if x['length'] <= 20 else x['length']  # 4-20å­—ç¬¦ä¼˜å…ˆ
    ))

    best_name = candidate_names[0]['text']

    # æœ€åéªŒè¯ï¼šå¦‚æœè¿˜æ˜¯å¤ªé•¿ï¼Œå–å‰20ä¸ªå­—ç¬¦
    if len(best_name) > 30:
        best_name = best_name[:20] + "..."

    return best_name
```

---

### æ–¹æ¡ˆ2ï¼šä¿®å¤è¯¦æƒ…é¡µä¿¡æ¯æå–é€»è¾‘

#### å…³é”®å‘ç°ï¼š
è¯¦æƒ…é¡µçº¢æ¡†åŒºåŸŸçš„XMLç»“æ„ç‰¹å¾ï¼š
1. **åŒºåŸŸèŒƒå›´**ï¼šYè½´å¤§çº¦åœ¨400-900ä¹‹é—´ï¼ˆå±å¹•ä¸ŠåŠéƒ¨åˆ†ï¼‰
2. **å•†å®¶å**ï¼šæœ€é¡¶éƒ¨å¤§å­—ï¼ˆY=200-500ï¼‰ï¼Œfont-sizeæœ€å¤§
3. **è¯„åˆ†**ï¼š3.8åˆ†ã€4.1åˆ†ç­‰ï¼ˆå¸¦æœ‰"åˆ†"å­—ï¼‰
4. **è¥ä¸šæ—¶é—´**ï¼šæ ¼å¼"XX:XX-XX:XX"
5. **åœ°å€**ï¼šåŒ…å«"åŒº"ã€"è·¯"ã€"å·"ç­‰
6. **ç”µè¯æŒ‰é’®**ï¼šæ–‡æœ¬åŒ…å«"ç”µè¯"æˆ–"è¡¥å……ç”µè¯"

#### ä¿®å¤ä»£ç ï¼š

```python
def _extract_merchant_name_from_detail(self, root, screen_height: int) -> str:
    """
    ä»å•†å®¶è¯¦æƒ…é¡µæå–åç§°ï¼ˆ2025-01-16å®Œå…¨é‡æ„ï¼‰

    ç­–ç•¥ï¼š
    1. æŸ¥æ‰¾Yè½´200-600èŒƒå›´å†…çš„æœ€å¤§å­—ä½“æ–‡æœ¬
    2. ä¼˜å…ˆHTMLæ ¼å¼<font size="XX">
    3. å¿…é¡»åœ¨é¡µé¢é¡¶éƒ¨çº¢æ¡†åŒºåŸŸå†…
    """
    all_text_nodes = root.xpath('//node[@text and string-length(@text) > 0 and @bounds]')

    candidates = []

    for node in all_text_nodes:
        text = node.get('text', '').strip()
        bounds_str = node.get('bounds', '')

        # è§£æbounds
        match = re.match(r'\[(\d+),(\d+)\]\[(\d+),(\d+)\]', bounds_str)
        if not match:
            continue

        x1, y1, x2, y2 = map(int, match.groups())

        # ğŸ†• å…³é”®1ï¼šYè½´å¿…é¡»åœ¨200-600ï¼ˆå•†å®¶ååŒºåŸŸï¼‰
        if not (200 <= y1 <= 600):
            continue

        # æ¸…ç†HTMLï¼Œæå–å­—ä½“å¤§å°
        font_size = 0
        clean_text = text

        # å°è¯•æå–HTML fontæ ‡ç­¾
        font_match = re.search(r'<font[^>]*size="(\d+)"[^>]*>([^<]+)</font>', text)
        if font_match:
            font_size = int(font_match.group(1))
            clean_text = font_match.group(2).strip()
        else:
            # æ²¡æœ‰HTMLæ ‡ç­¾ï¼Œç›´æ¥æ¸…ç†
            clean_text = re.sub(r'<[^>]+>', '', text).strip()

        # ğŸ†• å…³é”®2ï¼šé•¿åº¦å¿…é¡»åœ¨3-30å­—ç¬¦ï¼ˆå•†å®¶åç‰¹å¾ï¼‰
        if not (3 <= len(clean_text) <= 30):
            continue

        # ğŸ†• å…³é”®3ï¼šæ’é™¤éå•†å®¶åæ–‡æœ¬
        if self._is_excluded_text(clean_text):
            continue
        if self._is_address_text(clean_text):
            continue

        # æ’é™¤è¯„åˆ†ï¼ˆå¦‚"3.8 åˆ†"ï¼‰
        if re.match(r'^\d+\.\d+\s*åˆ†', clean_text):
            continue

        # æ’é™¤æ—¶é—´ï¼ˆå¦‚"09:00"ï¼‰
        if re.match(r'^\d{2}:\d{2}', clean_text):
            continue

        # æ’é™¤è¥ä¸šçŠ¶æ€
        if clean_text in ['è¥ä¸šä¸­', 'ä¼‘æ¯ä¸­', 'å³å°†è¥ä¸š']:
            continue

        # æ·»åŠ åˆ°å€™é€‰
        candidates.append({
            'text': clean_text,
            'font_size': font_size,
            'y_pos': y1,
            'length': len(clean_text)
        })

    if not candidates:
        print("âš  æœªèƒ½ä»è¯¦æƒ…é¡µæå–å•†å®¶åç§°")
        return "æœªçŸ¥å•†å®¶"

    # æ’åºè§„åˆ™ï¼š
    # 1. Yè½´ä½ç½®è¶Šé ä¸Šè¶Šå¥½ï¼ˆ200-400æœ€ä½³ï¼‰
    # 2. å­—ä½“è¶Šå¤§è¶Šå¥½ï¼ˆå•†å®¶åå­—ä½“æœ€å¤§ï¼‰
    # 3. é•¿åº¦é€‚ä¸­ï¼ˆ8-20å­—ç¬¦æœ€ä½³ï¼‰
    candidates.sort(key=lambda x: (
        x['y_pos'],                     # Yè½´ä½ç½®æœ€é‡è¦
        -x['font_size'],                # å­—ä½“å¤§å°ç¬¬äºŒé‡è¦
        abs(x['length'] - 12)           # é•¿åº¦æ¥è¿‘12æœ€å¥½
    ))

    best_name = candidates[0]['text']
    print(f"âœ“ ä»è¯¦æƒ…é¡µæå–å•†å®¶å: {best_name} (Y={candidates[0]['y_pos']}, å­—ä½“={candidates[0]['font_size']})")

    return best_name


def _extract_merchant_info_from_detail_area(self, root, screen_width: int, screen_height: int) -> Dict:
    """
    ä»è¯¦æƒ…é¡µçº¢æ¡†åŒºåŸŸæå–ä¿¡æ¯ï¼ˆ2025-01-16æ–°å¢ï¼‰

    çº¢æ¡†åŒºåŸŸç‰¹å¾ï¼š
    - Yè½´èŒƒå›´ï¼š400-1000ï¼ˆå¤§çº¦ï¼‰
    - åŒ…å«ï¼šç”µè¯æŒ‰é’®ã€åœ°å€ã€è¥ä¸šæ—¶é—´ã€è¯„åˆ†
    """
    detail_info = {
        'rating': '',
        'business_hours': '',
        'address': '',
        'phone_button_pos': None
    }

    all_text_nodes = root.xpath('//node[@text and string-length(@text) > 0 and @bounds]')

    for node in all_text_nodes:
        text = node.get('text', '').strip()
        clean_text = re.sub(r'<[^>]+>', '', text).strip()
        bounds_str = node.get('bounds', '')

        # è§£æbounds
        match = re.match(r'\[(\d+),(\d+)\]\[(\d+),(\d+)\]', bounds_str)
        if not match:
            continue

        x1, y1, x2, y2 = map(int, match.groups())

        # ğŸ†• åªå¤„ç†çº¢æ¡†åŒºåŸŸï¼ˆYè½´400-1000ï¼‰
        if not (400 <= y1 <= 1000):
            continue

        # 1. æå–è¯„åˆ†ï¼ˆX.X åˆ†ï¼‰
        if not detail_info['rating']:
            rating_match = re.search(r'(\d+\.\d+)\s*åˆ†', clean_text)
            if rating_match:
                detail_info['rating'] = rating_match.group(1)
                print(f"  æå–è¯„åˆ†: {detail_info['rating']}åˆ†")

        # 2. æå–è¥ä¸šæ—¶é—´ï¼ˆXX:XX-XX:XXï¼‰
        if not detail_info['business_hours']:
            time_match = re.search(r'(\d{2}:\d{2}[-~]\d{2}:\d{2})', clean_text)
            if time_match:
                detail_info['business_hours'] = time_match.group(1)
                print(f"  æå–è¥ä¸šæ—¶é—´: {detail_info['business_hours']}")

        # 3. æå–åœ°å€ï¼ˆåŒ…å«åŒº/è·¯/è¡—/å·ï¼‰
        if not detail_info['address']:
            if any(k in clean_text for k in ['åŒº', 'è·¯', 'è¡—', 'å·']):
                if len(clean_text) >= 10:
                    detail_info['address'] = clean_text
                    print(f"  æå–åœ°å€: {detail_info['address']}")

        # 4. å®šä½ç”µè¯æŒ‰é’®
        if not detail_info['phone_button_pos']:
            if 'ç”µè¯' in clean_text or 'è¡¥å……ç”µè¯' in clean_text:
                detail_info['phone_button_pos'] = {
                    'x': (x1 + x2) // 2,
                    'y': (y1 + y2) // 2
                }
                print(f"  å®šä½ç”µè¯æŒ‰é’®: ({detail_info['phone_button_pos']['x']}, {detail_info['phone_button_pos']['y']})")

    return detail_info
```

---

## ğŸ¯ å®Œæ•´ä¿®å¤æ­¥éª¤

### æ­¥éª¤1ï¼šä¿®å¤å•†å®¶åæå–ï¼ˆmerchant_card_locator.pyï¼‰
- æ›¿æ¢ `_extract_merchant_name` æ–¹æ³•
- å¢åŠ 5å±‚è¿‡æ»¤é€»è¾‘
- ä¼˜å…ˆé€‰æ‹©Yè½´é ä¸Šã€é•¿åº¦é€‚ä¸­çš„æ–‡æœ¬

### æ­¥éª¤2ï¼šä¿®å¤è¯¦æƒ…é¡µæå–ï¼ˆmerchant_collector.pyï¼‰
- æ›¿æ¢ `_extract_merchant_name_from_detail` æ–¹æ³•
- æ–°å¢ `_extract_merchant_info_from_detail_area` æ–¹æ³•
- åªä»çº¢æ¡†åŒºåŸŸï¼ˆY=400-1000ï¼‰æå–ä¿¡æ¯

### æ­¥éª¤3ï¼šæ›´æ–°é‡‡é›†æµç¨‹
- ç‚¹å‡»åå…ˆæå–å•†å®¶å
- éªŒè¯åç§°åŒ¹é…
- å†æå–çº¢æ¡†åŒºåŸŸè¯¦ç»†ä¿¡æ¯

---

## ğŸ“ é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰ï¼š
```
âŒ å¡ç‰‡è¯†åˆ«: ã€å¼—æ´›ä¼Šå¾·ã€‘5æ”¯å®¶å±…é²œèŠ±ç“¶æ’èŠ±...
âŒ è¯¦æƒ…é¡µæå–: è¾¾äººç¬”è®°
âŒ åç§°ä¸åŒ¹é…ï¼Œè·³è¿‡
```

### ä¿®å¤åï¼š
```
âœ… å¡ç‰‡è¯†åˆ«: æ‹‚è‹èŠ±åº—Floral.æ˜†æ˜
âœ… è¯¦æƒ…é¡µæå–: æ‹‚è‹èŠ±åº—Floral.æ˜†æ˜
âœ… åç§°åŒ¹é…
âœ… æå–ä¿¡æ¯:
   - è¯„åˆ†: 4.1åˆ†
   - è¥ä¸šæ—¶é—´: 10:00-22:00
   - åœ°å€: å®˜æ¸¡åŒºè‚–å®¶è¥å¤§æ£š2æœŸ487-488
   - ç”µè¯: [ç‚¹å‡»æå–]
```

---

**ä¸‹ä¸€æ­¥**ï¼šæˆ‘å°†ç«‹å³å®æ–½è¿™äº›ä¿®å¤ä»£ç ã€‚
