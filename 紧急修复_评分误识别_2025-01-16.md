# 紧急修复：评分被误识别为商家名

## 🔴 问题

```
期望: 艾植悟呈贡花卉经营部
实际: 4.1
```

**原因**：评分"4.1"被误识别为商家名！

---

## 🔍 根本原因分析

### 问题1：排序逻辑错误

**旧排序**（错误）：
```python
candidates.sort(key=lambda x: (
    x['y_pos'],           # ❌ Y轴位置最重要
    -x['font_size'],      # 字体大小第二
    abs(x['length'] - 12) # 长度第三
))
```

**导致**：
- 评分"4.1"的Y轴 = 769
- 商家名"艾植悟呈贡花卉经营部"的Y轴 = 700-750
- 因为按Y轴从小到大排序，**评分Y轴更小**，所以被优先选中！

**正确排序**：
```python
candidates.sort(key=lambda x: (
    -x['font_size'],      # ✅ 字体大小最重要（商家名字体最大）
    abs(x['length'] - 12), # 长度第二
    x['y_pos']            # Y轴最后考虑
))
```

---

### 问题2：没有排除纯数字评分

**旧代码**：
```python
# 只排除带"分"的评分
if re.match(r'^\d+\.\d+\s*分', clean_text):
    continue
```

**问题**：纯数字"4.1"、"3.8"没有被排除！

**新代码**：
```python
# 排除纯数字评分
if re.match(r'^\d+\.\d+$', clean_text):
    continue  # ✅ 排除"4.1"、"3.8"

# 排除带"分"的评分
if re.match(r'^\d+\.\d+\s*分', clean_text):
    continue  # ✅ 排除"4.1 分"
```

---

### 问题3：相似度匹配也没有排除评分

`_find_merchant_name_by_similarity()` 方法也会遍历所有文本，包括"4.1"。

**修复**：在相似度匹配前也排除评分。

---

## ✅ 修复内容

### 修复1：排除纯数字评分（2处）

#### 位置1：`_extract_merchant_name_from_detail()`
```python
# merchant_collector.py 第580行

# 🆕 关键：排除评分数字（如"3.8"、"4.1"）
if re.match(r'^\d+\.\d+$', clean_text):
    continue  # 纯数字评分
if re.match(r'^\d+\.\d+\s*分', clean_text):
    continue  # 带"分"的评分
```

#### 位置2：`_find_merchant_name_by_similarity()`
```python
# merchant_collector.py 第493行

# 🆕 关键过滤：排除明显不是商家名的文本
# 排除纯数字评分（如"4.1"、"3.8"）
if re.match(r'^\d+\.\d+$', clean_text):
    continue
# 排除时间
if re.match(r'^\d{2}:\d{2}', clean_text):
    continue
# 排除照片标签
if re.match(r'^照片\(\d+\)$', clean_text):
    continue
```

---

### 修复2：调整排序逻辑

**修复前**（错误）：
```python
candidates.sort(key=lambda x: (
    x['y_pos'],           # ❌ Y轴优先
    -x['font_size'],
    abs(x['length'] - 12)
))
```

**修复后**（正确）：
```python
# merchant_collector.py 第619行

candidates.sort(key=lambda x: (
    -x['font_size'],      # ✅ 字体最重要（商家名字体最大）
    abs(x['length'] - 12), # 长度第二（4-20字符）
    x['y_pos']            # Y轴最后
))
```

**逻辑**：
1. 商家名的字体最大（font-size最大）
2. 商家名长度适中（8-20字符，接近12最优）
3. 在字体和长度相同时，才比较Y轴

---

### 修复3：增加调试信息

```python
# merchant_collector.py 第628行

# 调试信息：显示前3个候选
if len(candidates) > 1:
    print(f"  候选商家名Top3:")
    for i, cand in enumerate(candidates[:3]):
        print(f"    [{i+1}] {cand['text']} (字体={cand['font_size']}, Y={cand['y_pos']}, 长度={cand['length']})")
```

**效果**：
```
候选商家名Top3:
  [1] 艾植悟呈贡花卉经营部 (字体=32, Y=700, 长度=11)
  [2] 花卉 (字体=0, Y=650, 长度=2)
  [3] 4.1 (字体=0, Y=769, 长度=3)  ← 已被排除，不会出现
✓ 从详情页提取商家名: 艾植悟呈贡花卉经营部
```

---

## 📊 修复效果对比

### 修复前：
```
❌ 提取到: 4.1 (Y=769, 字体=0)
❌ 期望: 艾植悟呈贡花卉经营部
❌ 实际: 4.1
❌ 字符重合度: 0%
❌ 商家名不匹配，跳过
```

### 修复后：
```
✅ 候选Top3:
   [1] 艾植悟呈贡花卉经营部 (字体=32, Y=700, 长度=11)
   [2] 官渡区... (字体=0, Y=850, 长度=25)
✅ 提取到: 艾植悟呈贡花卉经营部 (Y=700, 字体=32)
✅ 期望: 艾植悟呈贡花卉经营部
✅ 实际: 艾植悟呈贡花卉经营部
✅ 完全匹配！
✅ 提取信息成功
```

---

## 🎯 关键改进点

### 1. 字体大小优先
商家名的字体通常是页面中**最大**的（font-size=32、36等），而评分、地址等字体较小（font-size=0或12-16）。

### 2. 多重过滤
- ✅ 排除纯数字（4.1）
- ✅ 排除带"分"的（4.1 分）
- ✅ 排除时间（09:00）
- ✅ 排除照片（照片(1)）
- ✅ 排除地址
- ✅ 排除标签

### 3. 调试可见
显示Top3候选，方便排查问题。

---

## 🧪 测试案例

### 案例1：艾植悟呈贡花卉经营部

**详情页文本**：
```
照片(1)              Y=300
照片(2)              Y=400
艾植悟呈贡花卉经营部  Y=700  字体=32  ← 商家名
4.1                 Y=769  字体=0   ← 评分
官渡区肖家营...      Y=850  字体=0   ← 地址
```

**旧逻辑**：
1. 候选：艾植悟...(Y=700), 4.1(Y=769)
2. 排序：按Y轴，700 < 769
3. 选择：❌ "4.1" (因为Y轴最小)

**新逻辑**：
1. 过滤：排除"照片(1)"、"4.1"
2. 候选：艾植悟...(字体=32), 官渡区...(字体=0)
3. 排序：按字体，32 > 0
4. 选择：✅ "艾植悟呈贡花卉经营部"

---

### 案例2：昆明花之源

**详情页文本**：
```
昆明花之源          Y=650  字体=36  ← 商家名
4.5                Y=720  字体=0   ← 评分
```

**新逻辑**：
1. 过滤：排除"4.5"
2. 候选：昆明花之源(字体=36)
3. 选择：✅ "昆明花之源"

---

## 📋 修改文件

- ✅ `merchant_collector.py`
  - `_find_merchant_name_by_similarity()` - 增加评分过滤
  - `_extract_merchant_name_from_detail()` - 增加评分过滤 + 修改排序逻辑

---

## ✅ 修复完成

**现在能够**：
1. ✅ 正确识别商家名（不是评分）
2. ✅ 按字体大小优先选择
3. ✅ 显示Top3候选（方便调试）
4. ✅ 排除所有非商家名文本

**修复时间**：2025-01-16
**修复文件**：1个
**修改行数**：约30行
**关键改进**：字体优先 + 排除评分

---

准备重新测试！ 🚀
