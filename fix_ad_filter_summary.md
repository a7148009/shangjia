# 广告过滤修复总结

## 问题描述

根据日志分析，系统识别到的商家卡片中包含了顶部广告区域"鲜花配送推荐"，该区域不属于真实商家信息。

## 问题分析

### 1. Y轴坐标分析

从日志中提取的关键信息：

```
广告区域（需要过滤）：
- "鲜花配送推荐" 区域：Y=255-561

真实商家卡片（有效数据）：
- 卡片0: 肖家营三期钢塑大鹏17-1819  Y=612-810
- 卡片1: 矣六街道矣六村·步行7分钟     Y=865-1063  ✓ 这是我们需要的
- 卡片2: 肖家营花卉市场三期89-99号   Y=1118-1316
```

### 2. 原配置问题

- **原 `safe_y_min`**: 400（仍会识别到部分广告区域）
- **广告实际结束位置**: Y=561
- **真实商家开始位置**: Y=612

## 解决方案

### 修改1: 调整Y轴过滤参数

**文件**: `merchant_card_locator.py` 和 `config.yaml`

```yaml
# 修改前
safe_y_min: 400   # 会识别Y=400-561之间的广告部分

# 修改后
safe_y_min: 600   # 完全过滤掉Y<600的所有广告区域
```

**效果**:
- ✓ 完全过滤顶部广告区域（Y=255-561）
- ✓ 保留所有真实商家卡片（Y>=612）

### 修改2: 增强广告关键词过滤

**新增关键词**:
```python
'鲜花配送', '送货上门', '配送推荐', '服务', '推荐商家'
```

**双重保护**:
1. **Y轴坐标过滤**（主要防线）：直接排除Y<600的区域
2. **关键词过滤**（辅助防线）：即使通过Y轴检查，也会被关键词拦截

## 修改文件清单

### 1. merchant_card_locator.py

```python
# 第86行：调整safe_y_min
'safe_y_min': 600,  # 从400提高到600

# 第37-43行：增强广告关键词
self.ad_keywords = [
    # ... 原有关键词 ...
    '鲜花配送', '送货上门', '配送推荐', '服务', '推荐商家'
]
```

### 2. config.yaml

```yaml
# 第11行：调整safe_y_min
safe_y_min: 600

# 第105-112行：新增广告关键词
ad_keywords:
  # ... 原有关键词 ...
  - "鲜花配送"
  - "上门配送"
  - "配送服务"
  - "送货上门"
  - "配送推荐"
  - "服务推荐"
  - "推荐商家"
  - "买花榜"
```

## 验证要点

修复后，系统应该：

1. ✓ **只识别真实商家卡片**
   - 从第一个蓝薇花卉卡片开始（Y=612）
   - 跳过所有顶部广告区域

2. ✓ **提取正确信息**
   - 商家名称：蓝薇花卉
   - 地址：矣六街道矣六村二组117号
   - 步行距离：10分钟

3. ✓ **不提取广告内容**
   - 不提取"鲜花配送推荐"
   - 不提取"上门配送服务"等广告信息

## 预期效果

### 修复前
```
识别到 6个商家卡片：
[0] 鲜花配送推荐（广告）❌
[1] 馨爱鲜花配送服务（广告）❌
[2] 肖家营三期钢塑大鹏...
[3] 蓝薇花卉 ✓
[4] 秋恋家植物物语...
[5] 大罗家营村...
```

### 修复后
```
识别到 3个商家卡片：
[0] 蓝薇花卉 ✓
[1] 秋恋家植物物语...
[2] 大罗家营村...
```

## 技术要点

### Y轴过滤原理

```
屏幕布局：
┌─────────────────────────────┐
│  顶部搜索栏 (Y=0-255)       │
├─────────────────────────────┤
│  🚫 广告区域 (Y=255-561)    │ ← safe_y_min=600 过滤掉
├─────────────────────────────┤
│  ✓ 商家卡片1 (Y=612-810)    │ ← 保留
│  ✓ 商家卡片2 (Y=865-1063)   │ ← 保留
│  ✓ 商家卡片3 (Y=1118-1316)  │ ← 保留
│  ...                         │
├─────────────────────────────┤
│  底部导航 (Y>1800)          │ ← safe_y_max=1800 过滤掉
└─────────────────────────────┘
```

### 置信度评分机制

修复后的卡片识别会获得更高的置信度：

```python
# Y轴位置评分
if 500 <= bounds['y1'] <= 1500:  # 核心区域
    confidence *= 1.0             # 满分

# 蓝薇花卉卡片 (Y=612)
# 612 在 500-1500 范围内 ✓
# 最终置信度：1.00 (100%)
```

## 测试建议

1. **运行程序，观察日志输出**
   ```
   应该看到：
   ✓ 共识别 3 个商家卡片
   ✗ 不应该出现"鲜花配送推荐"等广告
   ```

2. **检查采集到的数据**
   ```
   第一个商家应该是：蓝薇花卉
   地址：矣六街道矣六村二组117号
   ```

3. **验证点击位置**
   ```
   点击位置应该在商家名称区域
   不应该点击到右侧按钮
   ```

## 注意事项

1. **参数可调整**
   - 如果发现有遗漏的真实商家，可适当降低 `safe_y_min`（如550）
   - 如果仍有广告漏网，可继续提高 `safe_y_min`（如650）

2. **不同屏幕适配**
   - 当前参数基于1080x2340分辨率
   - 其他分辨率可能需要调整Y轴参数

3. **动态广告位置**
   - 高德地图可能更新广告位置
   - 建议定期检查日志，根据实际情况调整参数

## 相关知识点回顾

1. **UI层级解析**：通过XML bounds属性获取元素位置
2. **多层过滤机制**：Y轴 + 宽度 + 高度 + 关键词
3. **置信度评分**：基于多个因素综合评估
4. **安全点击计算**：避开按钮区域，选择安全区域中心

---

**修复完成时间**: 2025-01-16
**修复人**: Claude Code
**影响范围**: 商家卡片识别准确率提升
